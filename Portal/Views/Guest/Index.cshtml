@{
	var values = new Dictionary<string, string>();
	List<News> news;

	using (var db = new SiteContext())
	{
		db.Guests
			.Value(x => x.Ip, Request.ServerVariables.Get("REMOTE_ADDR"))
			.Value(x => x.UserAgent, Request.ServerVariables.Get("HTTP_USER_AGENT"))
			.Value(x => x.Date, DateTime.Now)
			.Insert();

		foreach (var constant in db.Constants.ToList())
		{
			values[constant.Keyword] = constant.Value;
		}
	}
}

<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Витебская ТЭЦ</title>
	<link rel="icon" href="~/Content/Guest/img/favicon.ico" type="image/x-icon" />
	<link rel="stylesheet" href="~/Content/Guest/css/style.css" />
</head>

<body>
	<a class="header" href="~/">
		<img title='Филиал "Витебская ТЭЦ" РУП "Витебскэнерго"' src="~/Content/Guest/img/logo.png" />
	</a>

	<div class="nav">

		<div class="nav-button">
			<span>О филиале</span>
			<div class="nav-dropdown">
				<a href="~/docs/О_филиале/Официальное_наименование/">Официальное наименование "Витебская ТЭЦ" РУП "Витебскэнерго", почтовый адрес, адрес электронной почты, банковские реквизиты</a>
				<a href="~/docs/О_филиале/Структура/">Структура филиала "Витебская ТЭЦ" РУП "Витебскэнерго"</a>
				<a href="~/docs/О_филиале/Задачи_и_функции/">Задачи и функции  филиала "Витебская ТЭЦ"  РУП "Витебскэнерго"</a>
				<a href="~/docs/О_филиале/Руководители/">Сведения о руководителях  филиала "Витебская ТЭЦ"  РУП "Витебскэнерго"</a>
				<a href="~/docs/О_филиале/История/">История филиала</a>
				<a href="~/docs/О_филиале/Ветераны ТЭЦ/">Ветераны ТЭЦ</a>
				<a href="~/docs/О_филиале/Доска_почета/">Доска почета</a>
				<a href="~/docs/О_филиале/Документы/">Официальные документы</a>
			</div>
		</div>

		<div class="nav-button">
			<span>Обращения</span>
			<div class="nav-dropdown">
				<a href="~/docs/Обращения/Запись_на_прием/">Запись на прием к руководству</a>
				<a href="~/docs/Обращения/График_приема/">График личного приема граждан, в том числе индивидуальных предпринимателей, их представителей, представителей юридических лиц</a>
				<a href="~/docs/Обращения/Порядок_рассмотрения/">Порядок рассмотрения обращений</a>
				<a href="https://xn--80abnmycp7evc.xn--90ais/">Электронное обращение</a>
				<a href="~/docs/Обращения/Горячая_линия/">Телефоны "Горячей линии"</a>
				<a href="~/docs/Обращения/Вышестоящая_организация/">Вышестоящая организация</a>
				<a href="~/docs/Обращения/Нормативно-правовые_акты/">Нормативно-правовые акты</a>
			</div>
		</div>
		<div class="nav-button">
			<span>Административные процедуры</span>
			<div class="nav-dropdown">
				<a href="~/docs/Административные_процедуры/Перечень/">Перечень административных процедур</a>
				<a href="~/docs/Административные_процедуры/Бланки/">Формы (бланки) документов, необходимых для обращения, порядок их заполнения и представления</a>
				<a href="~/docs/Административные_процедуры/Специалисты/">Специалисты филиала осуществляющие прием заявлений заинтересованных лиц</a>
				<a href="~/docs/Административные_процедуры/Вышестоящая_организация/">Вышестоящая организация</a>
				<a href="~/docs/Административные_процедуры/Нормативно-правовые_акты/">Нормативно-правовые акты</a>
			</div>
		</div>

		<div class="nav-button">
			<span>Деятельность</span>
			<div class="nav-dropdown">
				<a href="~/docs/Деятельность/О_товарах,_работах,_услугах/">Порядок реализации</a>
				<a href="~/docs/Деятельность/Противодействие коррупции/">Противодействие коррупции</a>
				<a href="~/docs/Деятельность/Закупки/">Закупки</a>
				<a href="~/docs/Деятельность/Входной_контроль/">Входной контроль</a>
				<a href="~/docs/Деятельность/Единый_день_информирования/">Единый день информирования</a>
				<a href="http://www.vitebsk.energo.net/OTD/IDEOL/polit.htm">ЕДИ - РУП Витебскэнерго</a>
				<a href="~/docs/Деятельность/Отдых/">Отдых, оздоровление</a>
				<a href="~/docs/Деятельность/БРСМ/">БРСМ</a>
				<a href="~/docs/Деятельность/Здоровый_образ_жизни/">Здоровый образ жизни</a>
				<a href="~/docs/Деятельность/Планы развития филиала/">Планы развития филиала</a>
				<a href="~/docs/Деятельность/Директива1">Директива №1</a>
				<a href="~/docs/Деятельность/Социальная реклама">Социальная реклама</a>
			</div>
		</div>

		<div class="nav-button">
			<span>Ресурсы</span>
			<div class="nav-dropdown">
				<a href="~/docs/Деятельность/Профком/">Профком</a>
				<a href="~/docs/Ресурсы/Карты оценки опасностей и рисков/">Карты оценки опасностей и рисков</a>
				<a href="~/docs/Ресурсы/Реестр экологической информации/">Реестр экологической информации</a>
			</div>
		</div>

		<div class="nav-button last">
			<span>Контакты</span>
			<div class="nav-dropdown">
				<a href="~/phonebook/">Телефонный справочник</a>
				<a href="~/docs/Контакты/Обратная_связь/">Обратная связь</a>
			</div>
		</div>
	</div>

	<div class="body">
		<div class="left">
			<div class="left-block">
				<a href="~/phonebook" class="link">
					Телефонный справочник 
					<i class="material-icons preloader" id="preloader">sync</i>
				</a>
				<input type="search" class="search" placeholder="введите запрос и нажмите Enter" />
			</div>

			<div class="left-block">
				<a href="~/docs/О_филиале/Официальное_наименование/" class="link">Реквизиты</a>
				<p>Телефон: <span class="number">3-59</span></p>
				<p>Факс: <span class="number">37-34-41</span></p>
				<p>Городской телефон: <span class="number">+375 (212) 37-34-01</span></p>
				<p>
					Email: <a href="mailto:vst@vitebsk.energo.net" style="color: #206fb6;">vst@vitebsk.energo.net</a>
				</p>
				<p>
					<br />
					Режим работы:
					<br />
					понедельник-четверг: <span class="number">8:00 - 17:00</span>
					<br />
					пятница: <span class="number">8:00 - 15:45</span>
					<br />
					обед: <span class="number">12:30 - 13:15</span>
					<br />
					выходные: <span class="number">суббота, воскресенье</span>
				</p>
			</div>

			<div class="left-block">
				<a class="link" href="http://www.vst.vitebsk.energo.net/pages/weather/?date=@DateTime.Today.ToString("ddMMyyyy")">Прогноз погоды</a>
				@{
					try
					{
						var html = File.ReadAllText(@"\\web\wwwroot\Content\html\weather\index.html");
						<div>
							@Html.Raw(html)
						</div>
					}
					catch (Exception e)
					{
						<div class="hide">@e.Message</div>
					}
				}
				<p style="padding-top: .5em;">
					Текущая температура на улице <span id="weather" class="weather-table__temp">?</span> °C
				</p>
			</div>

			<div class="left-block">
				<a class="link">Курсы валют</a>
				<table class="money">
					<tr>
						<td width="40px"><img src="~/Content/images/money.rub.gif" /></td>
						<td>100 российских рублей</td>
						<td class="number">@Convert.ToSingle(values["RUB"]).ToString("0.00")</td>
					</tr>
					<tr>
						<td><img src="~/Content/images/money.eur.gif" /></td>
						<td>1 евро</td>
						<td class="number">@Convert.ToSingle(values["EUR"]).ToString("0.00")</td>
					</tr>
					<tr>
						<td><img src="~/Content/images/money.usd.gif" /></td>
						<td>1 доллар США</td>
						<td class="number">@Convert.ToSingle(values["USD"]).ToString("0.00")</td>
					</tr>
				</table>
			</div>
		</div>

		<div class="right">
			<div id="contacts"></div>
			<div id="news">
				@Html.Action("News", new { take = 20 })
			</div>
		</div>
	</div>

	<script>
		document.querySelectorAll('.nav-button').forEach(function (el) {
			var timeout = 0
			el.addEventListener('mouseenter', function () {
				timeout = setTimeout(function () {
					el.classList.add('visible')
					document.querySelector('.body').classList.add('visible')
				}, 250)
			})
			el.addEventListener('mouseleave', function () {
				clearTimeout(timeout)
				el.classList.remove('visible')
				document.querySelector('.body').classList.remove('visible')
			})
		})

		setInterval(function () {
			fetch('@Url.Action("weather", "guest")?r=' + Math.random())
				.then(function (res) { return res.text() })
				.then(function (text) { document.getElementById('weather').innerHTML = Number(text).toFixed(2) })
		}, 1000)

		document.addEventListener('click', function (ev) {
			var el = ev.target
			if (el.classList.contains('news-preview')) {
				var body = el.parentNode
				fetch('@Url.Action("body", "guest")?id=' + body.getAttribute('news-id'))
					.then(function (res) { return res.text() })
					.then(function (text) { body.innerHTML = text })
			}
		})

		var isLoading = false

		window.addEventListener('scroll', function () {
			if (isLoading) return

			var scrollHeight = Math.max(
				document.body.scrollHeight, document.documentElement.scrollHeight,
				document.body.offsetHeight, document.documentElement.offsetHeight,
				document.body.clientHeight, document.documentElement.clientHeight
			)
			if (scrollHeight - this.window.pageYOffset < 1200) {
				isLoading = true

				var news = document.querySelectorAll('[news-id]')
				var last = news.length > 0 ? (news[news.length - 1]).getAttribute('news-id') : 0

				fetch('@Url.Action("news", "guest")?take=10&skip=' + last)
					.then(function (res) { return res.text() })
					.then(function (text) {
						document.getElementById('news').insertAdjacentHTML('beforeend', text)
						isLoading = false
					})
			}
		})

		document.querySelector('.search').addEventListener('search', function (ev) {
			var value = ev.target.value
			if (value.length > 1) {
				preload()
				fetch('@Url.Action("contacts", "guest")?search=' + encodeURIComponent(value))
					.then(function (res) { return res.text() })
					.then(function (text) {
						if (text.length > 0) {
							show(text)
						}
						else {
							hide()
						}
					})
			}
			else {
				hide()
			}

			function preload() {
				document.getElementById('preloader').style.display = 'block'
			}

			function show(text) {
				document.getElementById('preloader').style.display = 'none'
				document.getElementById('news').style.display = 'none'
				document.getElementById('contacts').innerHTML = text
				document.getElementById('contacts').style.display = 'block'
			}

			function hide() {
				document.getElementById('preloader').style.display = 'none'
				document.getElementById('contacts').style.display = 'none'
				document.getElementById('contacts').innerHTML = ''
				document.getElementById('news').style.display = 'block'
			}
		})
	</script>
</body>
</html>